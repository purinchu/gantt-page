<!DOCTYPE html>
<html><head>
<meta charset="utf-8"/>
<title>Project Gantt generator</title>
<style>
html,body {
    width: 100%;
    height: 100%;
    margin: 0px;
}

div#content {
    display: grid;
    grid-template-columns: 1fr 2fr;
    grid-gap: 10px;

}

.chart {
    font-size: 12px;
}

.axis path,.axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
}

.bar {
    fill: #33b5e5;
}

.bar-failed {
    fill: #CC0000;
}

.bar-running {
    fill: #669900;
}

.bar-succeeded {
    fill: #33b5e5;
}

.bar-killed {
    fill: #ffbb33;
}
</style>
</head>
<body>
    <h3>Gantt Viewer</h3>

    <div id="content">
        <div id="input_wrapper">
            <textarea cols="50" rows="50" id="task_input">
-- Major Group 1 --
RMF Step 5 from 2018-04-02 to 2018-04-12
A Job from 2018-05-01 to 2018-05-30
            </textarea>
            <button id="btn_load_tasks">Load Tasks into Chart</button>
        </div>

        <div id="gantt_wrapper"></div>
    </div>

    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="gantt.js"></script>

    <script>

let btnLoadTasks = document.getElementById('btn_load_tasks');

btnLoadTasks.addEventListener('click', (ev) => {
    let inputArea = document.getElementById('task_input');
    const taskInput = inputArea.value;

    console.log("Loading gantt chart with " + taskInput);

    const tasks = parseTasks(taskInput);
    setupGanttChart(tasks);
});

function taskFromInputLine(line) {
    const line_re = /^\s*([a-zA-Z0-9_ ]+) [fF]rom (2[0-9]{3}-[0-1]?[0-9]-[0-3]?[0-9]) [tT]o (2[0-9]{3}-[0-1]?[0-9]-[0-3]?[0-9])\s*$/;

    let result = line_re.exec(line);
    if (result) {
        return {
            startDate: new Date(result[2]),
            endDate  : new Date(result[3]),
            taskName : result[1],
            status   : "TASK"
        };
    }

    // Look for header line
    result = /^\s*--+\s*(.*)\s*--+\s*$/.exec(line);
    if (result) {
        return {
            startDate: new Date(2037, 12, 31),
            endDate  : new Date(1970, 0, 1),
            taskName : result[1].trim(),
            status   : "HEADER"
        }
    }

    return null;
}

function parseTasks(taskInput) {
    let tasks = [];
    var curHeader;

    const lines = taskInput.trim().split(/\n+/);
    for (const line of lines) {
        const task = taskFromInputLine(line.trim());

        if (task) {
            if (task.status === "HEADER") {
                // New header
                curHeader = task;
            }
            else if (curHeader) {
                tasks.header = curHeader;
                curHeader.startDate =
                    (task.startDate.getTime() < curHeader.startDate.getTime())
                        ? task.startDate
                        : curHeader.startDate;
                curHeader.endDate =
                    (task.endDate.getTime() > curHeader.endDate.getTime())
                        ? task.endDate
                        : curHeader.endDate;
            }

            tasks.push(task);
        } else {
            throw "Invalid task " + line + "!";
        }
    }

    return tasks;
}

let gantt;

function setupGanttChart(tasks) {
    // Maps task statuses to CSS class names
    const taskStatus = {
        "HEADER" : "bar",
        "FAILED" : "bar-failed",
        "TASK" : "bar-running",
        "KILLED" : "bar-killed"
    };

    const taskNames = [ ...(new Set(tasks.map((x) => x.taskName))) ];

    if (!gantt) {
        gantt = d3.gantt()
            .taskTypes(taskNames)
            .taskStatus(taskStatus)
            .tickFormat("%b (%V)");
        gantt(tasks);
    }
    else {
        gantt.taskTypes(taskNames)
            .redraw(tasks);
    }
}
    </script>
</body></html>
