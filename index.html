<!DOCTYPE html>
<html><head>
<meta charset="utf-8"/>
<title>Project Gantt generator</title>
<style>
html,body {
    width: 100%;
    height: 100%;
    margin: 0px;
}

div#content {
    display: grid;
    grid-template-columns: 1fr 2fr;
    grid-gap: 10px;

}

.chart {
    font-size: 12px;
}

.axis path,.axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
}

.bar {
    fill: #33b5e5;
}

.bar-failed {
    fill: #CC0000;
}

.bar-running {
    fill: #669900;
}

.bar-succeeded {
    fill: #33b5e5;
}

.bar-killed {
    fill: #ffbb33;
}
</style>
</head>
<body>
    <h3>Gantt Viewer</h3>

    <div id="content">
        <div id="input_wrapper">
            <textarea cols="50" rows="50" id="task_input">
RMF Step 5 from 2018-04-02 to 2018-04-12
A Job from 2018-05-01 to 2018-05-30
            </textarea>
            <button id="btn_load_tasks">Load Tasks into Chart</button>
        </div>

        <div id="gantt_wrapper"></div>
    </div>

    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="gantt.js"></script>

    <script>

let btnLoadTasks = document.getElementById('btn_load_tasks');

btnLoadTasks.addEventListener('click', (ev) => {
    let inputArea = document.getElementById('task_input');
    const taskInput = inputArea.value;

    console.log("Loading gantt chart with " + taskInput);

    const tasks = parseTasks(taskInput);
    setupGanttChart(tasks);
});

function taskFromInputLine(line) {
    const line_re = /^\s*([a-zA-Z0-9_ ]+) [fF]rom (2[0-9]{3}-[0-1]?[0-9]-[0-3]?[0-9]) [tT]o (2[0-9]{3}-[0-1]?[0-9]-[0-3]?[0-9])\s*$/;
    let result = line_re.exec(line);
    if (!result) { return null; }

    return {
        startDate: new Date(result[2]),
        endDate  : new Date(result[3]),
        taskName : result[1],
        status   : "RUNNING"
    };
}

function parseTasks(taskInput) {
    let tasks = [];

    const lines = taskInput.trim().split(/\n+/);
    for (const line of lines) {
        const task = taskFromInputLine(line.trim());
        if (task) {
            tasks.push(task);
        } else {
            throw "Invalid task " + line + "!";
        }
    }

    return tasks;
}

function setupGanttChart(tasks) {
    // Maps task statuses to CSS class names
    const taskStatus = {
        "SUCCEEDED" : "bar",
        "FAILED" : "bar-failed",
        "RUNNING" : "bar-running",
        "KILLED" : "bar-killed"
    };

    const taskNames = [ ...(new Set(tasks.map((x) => x.taskName))) ];
    const format = "%x";

    // TODO: Figure out how to clear existing gantt if one is present

    let gantt = d3.gantt()
        .taskTypes(taskNames)
        .taskStatus(taskStatus)
        .tickFormat("%b (%V)");

    gantt(tasks);
}
    </script>
</body></html>
